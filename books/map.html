<!doctype html>
<html lang="ca">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Llibres per país</title>

    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 16px;
      }
      #geo {
        width: 100%;
        height: 520px;
        border: 1px solid #eee;
        border-radius: 10px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 12px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        vertical-align: top;
      }
      th {
        position: sticky;
        top: 0;
        background: #f6f6f6;
        text-align: left;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      @media (min-width: 900px) {
        .row {
          grid-template-columns: 1.2fr 1fr;
        }
      }
      .card {
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 12px;
      }
      .muted {
        color: #666;
        margin: 0 0 8px 0;
      }
      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin: 6px 0 0 0;
      }
      .link {
        color: #0b57d0;
        cursor: pointer;
        text-decoration: underline;
      }
      .pill {
        font-size: 12px;
        background: #f3f3f3;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid #e6e6e6;
      }
    </style>

    <script src="https://www.gstatic.com/charts/loader.js"></script>
  </head>

  <body>
    <h1>Mapa de lectures</h1>
    <p id="hint" class="muted">Clica un país per filtrar la taula.</p>

    <div class="row">
      <div class="card">
        <div id="geo">Carregant mapa…</div>

        <div class="toolbar">
          <label class="muted">Any:</label>
          <select id="yearSelect">
            <option value="ALL">Tots</option>
          </select>

          <label class="muted">Vista:</label>
          <select id="viewSelect">
            <option value="countries">Països</option>
            <option value="subcontinents">Subcontinents</option>
            <option value="continents">Continents</option>
          </select>

          <span id="yearPill" class="pill" style="display: none"></span>
          <span id="filterPill" class="pill" style="display: none"></span>
          <span id="resetLink" class="link" style="display: none">Mostra tots</span>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h2>Taula de llibres</h2>
        <div id="app">Carregant taula…</div>
      </div>
    </div>

    <script>
      const URLS = {
        books: "./assets/books.json",
        writers: "./assets/writers.json",
        languages: "./assets/languages.json",
        countries: "./assets/countries.json",
      };

      async function loadJSON(url) {
        const r = await fetch(url);
        if (!r.ok) throw new Error(`Error carregant ${url}: ${r.status} ${r.statusText}`);
        return r.json();
      }

      function indexBy(arr, keyFn) {
        const m = new Map();
        arr.forEach((i) => m.set(keyFn(i), i));
        return m;
      }

      async function buildEnrichedBooks() {
        const [books, writers, languages, countries] = await Promise.all([
          loadJSON(URLS.books),
          loadJSON(URLS.writers),
          loadJSON(URLS.languages),
          loadJSON(URLS.countries),
        ]);

        const writersByName = indexBy(writers, (w) => w.name);
        const countriesByCode = indexBy(countries, (c) => c.code);

        return books.map((book) => {
          const writer = writersByName.get(book.writer);
          const country = writer ? countriesByCode.get(writer.country) : null;
          return {
            ...book,
            writerCountryCode: writer?.country ?? null,
            writerCountryName: country?.name ?? null,
          };
        });
      }

      function renderTable(container, rows) {
        if (!rows.length) {
          container.innerHTML = "No hi ha dades";
          return;
        }
        let html =
          "<table><thead><tr><th>Títol</th><th>Autor</th><th>Any</th><th>País</th></tr></thead><tbody>";
        rows.forEach((r) => {
          html += `<tr><td>${escapeHtml(r.name ?? "")}</td><td>${escapeHtml(r.writer ?? "")}</td><td>${escapeHtml(r.read ?? "")}</td><td>${escapeHtml(r.writerCountryName ?? "")}</td></tr>`;
        });
        html += "</tbody></table>";
        container.innerHTML = html;
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // ---------- Any ----------
      function getReadYears(books) {
        const years = new Set();
        for (const b of books) {
          const v = b.read;
          const n = typeof v === "number" ? v : Number(v);
          if (Number.isFinite(n)) years.add(String(n));
        }
        return Array.from(years).sort((a, b) => Number(a) - Number(b));
      }

      function fillYearSelect(selectEl, years) {
        selectEl.innerHTML =
          `<option value="ALL">Tots</option>` +
          years.map((y) => `<option value="${y}">${y}</option>`).join("");
      }

      // ---------- UN M49 + noms ----------
      const CONTINENT_BY_ISO2 = {
        AF: "142",
        AR: "019",
        AT: "150",
        AU: "009",
        BA: "150",
        BD: "142",
        BE: "150",
        BG: "150",
        BI: "002",
        BO: "019",
        BY: "150",
        CA: "019",
        CG: "002",
        CH: "150",
        CN: "142",
        CO: "019",
        CU: "019",
        DE: "150",
        DZ: "002",
        EC: "019",
        ES: "150",
        FI: "150",
        FR: "150",
        GB: "150",
        GE: "142",
        GP: "019",
        GR: "150",
        HT: "019",
        HU: "150",
        IE: "150",
        IL: "142",
        IN: "142",
        IT: "150",
        JP: "142",
        KR: "142",
        MX: "019",
        MY: "142",
        NG: "002",
        NO: "150",
        NZ: "009",
        PL: "150",
        PS: "142",
        RO: "150",
        RU: "150",
        SE: "150",
        SL: "002",
        TR: "142",
        TW: "142",
        UA: "150",
        US: "019",
        ZA: "002",
      };

      const SUBCONTINENT_BY_ISO2 = {
        // Asia
        AF: "034",
        BD: "034",
        IN: "034",
        CN: "030",
        JP: "030",
        KR: "030",
        TW: "030",
        MY: "035",
        GE: "145",
        IL: "145",
        PS: "145",
        TR: "145",

        // Europe
        AT: "155",
        BE: "155",
        CH: "155",
        DE: "155",
        FR: "155",
        ES: "039",
        IT: "039",
        GR: "039",
        BA: "039",
        BG: "151",
        BY: "151",
        HU: "151",
        PL: "151",
        RO: "151",
        RU: "151",
        UA: "151",
        FI: "154",
        GB: "154",
        IE: "154",
        NO: "154",
        SE: "154",

        // Africa
        DZ: "015",
        BI: "014",
        CG: "017",
        NG: "011",
        SL: "011",
        ZA: "018",

        // Americas
        US: "021",
        CA: "021",
        MX: "013",
        AR: "005",
        BO: "005",
        CO: "005",
        EC: "005",
        CU: "029",
        HT: "029",
        GP: "029",

        // Oceania
        AU: "053",
        NZ: "053",
      };

      const M49_CONTINENT_NAME = {
        "002": "Àfrica",
        "009": "Oceania",
        "019": "Amèrica",
        "142": "Àsia",
        "150": "Europa",
      };

      const M49_SUBCONTINENT_NAME = {
        "014": "Àfrica oriental",
        "015": "Àfrica del nord",
        "017": "Àfrica central",
        "018": "Àfrica austral",
        "011": "Àfrica occidental",
        "029": "Carib",
        "021": "Amèrica del nord",
        "013": "Amèrica central",
        "419": "Amèrica Llatina i el Carib",
        "005": "Amèrica del sud",
        "030": "Àsia oriental",
        "034": "Àsia meridional",
        "035": "Àsia sud-oriental",
        "143": "Àsia central",
        "145": "Àsia occidental",
        "151": "Europa oriental",
        "154": "Europa del nord",
        "155": "Europa occidental",
        "039": "Europa meridional",
        "053": "Austràlia i Nova Zelanda",
        "054": "Melanèsia",
        "057": "Micronèsia",
        "061": "Polinèsia",
      };

      function getRegionNameForSelection(selectedView, selectedRegionCode, books) {
        if (!selectedRegionCode) return null;

        if (selectedView === "countries") {
          // intenta trobar el nom al dataset
          const found =
            books.find((b) => b.writerCountryCode === selectedRegionCode && b.writerCountryName)?.writerCountryName;
          return found || selectedRegionCode;
        }

        if (selectedView === "continents") {
          return M49_CONTINENT_NAME[selectedRegionCode] || selectedRegionCode;
        }

        return M49_SUBCONTINENT_NAME[selectedRegionCode] || selectedRegionCode;
      }

      // ---------- Agregació ----------
      function aggregateByCountry(books) {
        const m = new Map();
        books.forEach((b) => {
          if (!b.writerCountryCode) return;
          const prev = m.get(b.writerCountryCode) || { count: 0, name: b.writerCountryName ?? b.writerCountryCode };
          prev.count++;
          m.set(b.writerCountryCode, prev);
        });
        return m;
      }

      function aggregateByGeoLevel(books, level) {
        if (level === "countries") return aggregateByCountry(books);

        const dict = level === "continents" ? CONTINENT_BY_ISO2 : SUBCONTINENT_BY_ISO2;
        const nameMap = level === "continents" ? M49_CONTINENT_NAME : M49_SUBCONTINENT_NAME;

        const m = new Map();

        books.forEach((b) => {
          const iso = b.writerCountryCode;
          if (!iso) return;

          const code = dict[iso];
          if (!code) return;

          const humanName = nameMap[code] || code;

          const prev = m.get(code) || { count: 0, name: humanName };
          prev.count++;
          m.set(code, prev);
        });

        return m;
      }

      // ---------- Filtre (clic) ----------
      function bookMatchesSelection(b, selectedView, selectedRegionCode) {
        if (!selectedRegionCode) return true;

        const iso = b.writerCountryCode;
        if (!iso) return false;

        if (selectedView === "countries") return iso === selectedRegionCode;
        if (selectedView === "continents") return CONTINENT_BY_ISO2[iso] === selectedRegionCode;
        return SUBCONTINENT_BY_ISO2[iso] === selectedRegionCode;
      }

      // ---------- GeoChart ----------
      function drawGeoChart(agg, onSelect, viewLevel) {
        const data = new google.visualization.DataTable();
        data.addColumn("string", "Region");
        data.addColumn("number", "Books");
        data.addColumn({ type: "string", role: "tooltip" });

        const rows = [];
        agg.forEach((v, k) => {
          const tooltip = `${v.name} — ${v.count} llibre${v.count === 1 ? "" : "s"}`;
          rows.push([k, Math.pow(v.count, 0.4), tooltip]);
        });
        data.addRows(rows);

        const options = {
          legend: "none",
          backgroundColor: "#E8FAFF",
          datalessRegionColor: "#F1EED8",
          tooltip: { textStyle: { fontSize: 12 } },
          colorAxis: { colors: ["#FFE5B4", "#FFB26B", "#E36414"] },
          resolution: viewLevel, // 'countries' | 'continents' | 'subcontinents'
        };

        const chart = new google.visualization.GeoChart(document.getElementById("geo"));
        chart.draw(data, options);

        google.visualization.events.addListener(chart, "select", () => {
          const sel = chart.getSelection();
          if (!sel.length) return;
          const code = data.getValue(sel[0].row, 0); // ISO2 o M49 segons viewLevel
          onSelect(code);
        });

        // Redibuix en resize
        window.addEventListener("resize", () => chart.draw(data, options), { passive: true });
      }

      // ---------- App ----------
      window.addEventListener("DOMContentLoaded", async () => {
        const app = document.getElementById("app");
        const geo = document.getElementById("geo");
        const yearSelect = document.getElementById("yearSelect");
        const viewSelect = document.getElementById("viewSelect");
        const resetLink = document.getElementById("resetLink");
        const yearPill = document.getElementById("yearPill");
        const filterPill = document.getElementById("filterPill");
        const hint = document.getElementById("hint");

        let books;
        try {
          books = await buildEnrichedBooks();
        } catch (e) {
          console.error(e);
          app.textContent = "Error carregant dades. Mira la consola (F12).";
          geo.textContent = "No s'ha pogut carregar el mapa.";
          return;
        }

        // Omple anys
        const years = getReadYears(books);
        fillYearSelect(yearSelect, years);

        let selectedView = viewSelect.value;     // countries | continents | subcontinents
        let selectedRegionCode = null;           // ISO2 si countries, M49 si altres
        let selectedYear = yearSelect.value;     // ALL o any

        function updateHint() {
          const label =
            selectedView === "countries" ? "país" :
            selectedView === "continents" ? "continent" :
            "subcontinent";
          hint.textContent = `Clica un ${label} per filtrar la taula.`;
        }

        function resetAll() {
          selectedRegionCode = null;
          selectedYear = "ALL";
          yearSelect.value = "ALL";
          updateUI();
        }

        function updateUI() {
          updateHint();

          // Filtre per any
          const yearFiltered =
            selectedYear === "ALL"
              ? books
              : books.filter((b) => String(b.read) === String(selectedYear));

          // Filtre per selecció (país/continent/subcontinent)
          const filtered =
            selectedRegionCode
              ? yearFiltered.filter((b) => bookMatchesSelection(b, selectedView, selectedRegionCode))
              : yearFiltered;

          // Taula
          renderTable(app, filtered);

          // Pills
          if (selectedYear === "ALL") {
            yearPill.style.display = "none";
          } else {
            yearPill.textContent = `Any: ${selectedYear}`;
            yearPill.style.display = "";
          }

          if (!selectedRegionCode) {
            filterPill.style.display = "none";
          } else {
            const regionName = getRegionNameForSelection(selectedView, selectedRegionCode, books);
            filterPill.textContent = `${regionName} (${filtered.length})`;
            filterPill.style.display = "";
          }

          // Mostra/Amaga reset
          const hasAnyFilter = !!selectedRegionCode || selectedYear !== "ALL";
          resetLink.style.display = hasAnyFilter ? "" : "none";

          // Mapa: el mapa reflecteix els filtres actuals (any + selecció)
          const agg = aggregateByGeoLevel(filtered, selectedView);
          if (agg.size === 0) {
            geo.textContent = "No hi ha dades per al mapa amb aquest filtre.";
            return;
          }

          drawGeoChart(
            agg,
            (code) => {
              selectedRegionCode = code;
              updateUI();
            },
            selectedView
          );
        }

        viewSelect.addEventListener("change", () => {
          selectedView = viewSelect.value;
          selectedRegionCode = null; // perquè el codi canvia (ISO2 vs M49)
          updateUI();
        });

        yearSelect.addEventListener("change", () => {
          selectedYear = yearSelect.value;
          updateUI();
        });

        resetLink.addEventListener("click", resetAll);

        google.charts.load("current", { packages: ["geochart"] });
        google.charts.setOnLoadCallback(updateUI);
      });
    </script>
  </body>
</html>