<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Llibres per país</title>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    #geo { width: 100%; height: 520px; border: 1px solid #eee; border-radius: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { position: sticky; top: 0; background: #f6f6f6; text-align: left; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .row { grid-template-columns: 1.2fr 1fr; } }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 12px; }
    .muted { color: #666; margin: 0 0 8px 0; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 6px 0 0 0; }
    .link { color: #0b57d0; cursor: pointer; text-decoration: underline; }
    .pill { font-size: 12px; background: #f3f3f3; padding: 4px 8px; border-radius: 999px; border: 1px solid #e6e6e6; }
  </style>

  <script src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
  <h1>Mapa de lectures</h1>
  <p class="muted">Clica un país per filtrar la taula.</p>

  <div class="row">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Mapa del món</h2>
      <div id="geo">Carregant mapa…</div>
      <div class="toolbar">
        <label class="muted" for="yearSelect">Any (llegit):</label>
        <select id="yearSelect">
          <option value="ALL">Tots</option>
        </select>
        <label class="muted" for="viewSelect">Vista:</label>
        <select id="viewSelect">
          <option value="countries">Països</option>
          <option value="subcontinents">Subcontinents</option>
          <option value="continents">Continents</option>
        </select>
        <span id="yearPill" class="pill" style="display:none;"></span>
        <span id="filterPill" class="pill" style="display:none;"></span>
        <span id="resetLink" class="link" style="display:none;">Mostra tots</span>
      </div>
      <p class="muted" style="margin-top:8px;">
        Passa el ratolí per sobre d'un país per veure el total de llibres.
      </p>
    </div>
</div>

<div class="row">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Taula de llibres</h2>
      <div id="app">Carregant taula…</div>
    </div>
  </div>

<script>
  // ----------------------- Config -----------------------
  const URLS = {
    books: "./assets/books.json",
    writers: "./assets/writers.json",
    languages: "./assets/languages.json",
    countries: "./assets/countries.json",
  };

  // Columnes que NO volem mostrar a la taula
  const HIDDEN_COLUMNS = new Set(["id", "cover", "language", "writerCountryCode", "writerGender"]);

  // Columnes que SÍ volem mostrar i en quin ordre + capçalera en català
  const TABLE_SCHEMA = [
    { key: "name",             label: "títol" },
    { key: "writer",           label: "autor" },
    { key: "published",        label: "publicat" },
    { key: "read",             label: "llegit" },
    { key: "rating",           label: "valoració" },
    { key: "writerCountryName",label: "país autor" }
  ];

  // ----------------------- Load + Join -----------------------
  async function loadJSON(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Error carregant ${url}: ${res.status} ${res.statusText}`);
    return res.json();
  }

  function indexBy(arr, keyFn) {
    const map = new Map();
    for (const item of arr) map.set(keyFn(item), item);
    return map;
  }

  async function buildEnrichedBooks() {
    const [books, writers, languages, countries] = await Promise.all([
      loadJSON(URLS.books),
      loadJSON(URLS.writers),
      loadJSON(URLS.languages),
      loadJSON(URLS.countries),
    ]);

    const writersByName = indexBy(writers, (w) => w.name);
    const languagesByCode = indexBy(languages, (l) => l.code);
    const countriesByCode = indexBy(countries, (c) => c.code);

    return books.map((book) => {
      const writer = writersByName.get(book.writer) || null;
      const language = languagesByCode.get(book.language) || null;
      const country = writer ? (countriesByCode.get(writer.country) || null) : null;

      return {
        ...book,
        originalLanguageName: language?.name ?? null,
        writerGender: writer?.gender ?? null,
        writerCountryCode: writer?.country ?? null, // ISO (ex: "ES")
        writerCountryName: country?.name ?? null,   // ex: "Spain"
      };
    });
  }

  // ----------------------- Table -----------------------
  function translateGender(value) {
  if (value === null || value === undefined) return "no definit";

  const map = {
    male: "masculí",
    female: "femení",
    nb: "no binari",
  };

  return map[value] || value;
}

function renderStars(value) {
  if (value === null || value === undefined || value === "") return "";
  const num = Number(value);
  if (isNaN(num)) return value;

  const fullStar = "★";
  const emptyStar = "☆";
  const max = 5; 

  return fullStar.repeat(num) + emptyStar.repeat(Math.max(0, max - num));
}

function toCellValue(key, value) {
  if (value === null || value === undefined) {
    if (key === "writerGender") return "no definit";
    return "";
  }

  // Traducció del gènere
  if (key === "writerGender") {
    return translateGender(value);
  }

  // Valoració com estrelles
  if (key === "rating") {
    return renderStars(value);
  }

  if (typeof value === "object") return JSON.stringify(value);

  return String(value);
}

  function renderTable(container, rows) {
    const table = document.createElement("table");

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");

    // Capçaleres en català segons l'esquema
    for (const col of TABLE_SCHEMA) {
      if (HIDDEN_COLUMNS.has(col.key)) continue;
      const th = document.createElement("th");
      th.textContent = col.label;
      trh.appendChild(th);
    }
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    for (const row of rows) {
      const tr = document.createElement("tr");
      for (const col of TABLE_SCHEMA) {
        if (HIDDEN_COLUMNS.has(col.key)) continue;
        const td = document.createElement("td");
        td.textContent = toCellValue(col.key, row[col.key]);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);

    container.innerHTML = "";
    container.appendChild(table);
  }

  // ----------------------- Aggregation for Map -----------------------
  // UN M49 codes que fa servir GeoChart per continents/subcontinents
  // (ve la llista completa a la doc) :contentReference[oaicite:1]{index=1}
  const CONTINENT_BY_ISO2 = {
    // Europe
    ES:"150", FR:"150", IT:"150", PT:"150", DE:"150", GB:"150", IE:"150", NL:"150", BE:"150", LU:"150",
    CH:"150", AT:"150", SE:"150", NO:"150", DK:"150", FI:"150", IS:"150", PL:"150", CZ:"150", SK:"150",
    HU:"150", RO:"150", BG:"150", GR:"150", HR:"150", SI:"150", RS:"150", BA:"150", ME:"150", MK:"150",
    AL:"150", EE:"150", LV:"150", LT:"150", UA:"150", BY:"150", MD:"150", RU:"150",
    // Africa
    MA:"002", DZ:"002", TN:"002", LY:"002", EG:"002", SD:"002", SS:"002", ET:"002", KE:"002", NG:"002",
    ZA:"002", GH:"002", SN:"002", CI:"002", CM:"002", UG:"002", TZ:"002", AO:"002", MZ:"002",
    // Asia
    TR:"142", SA:"142", AE:"142", IL:"142", IQ:"142", IR:"142", IN:"142", PK:"142", CN:"142", JP:"142",
    KR:"142", ID:"142", TH:"142", VN:"142",
    // Americas
    US:"019", CA:"019", MX:"019", BR:"019", AR:"019", CL:"019", CO:"019", PE:"019",
    // Oceania
    AU:"009", NZ:"009"
  };

  // Subcontinents (M49)
  const SUBCONTINENT_BY_ISO2 = {
    // Southern Europe
    ES:"039", PT:"039", IT:"039", GR:"039", AD:"039", MT:"039",
    // Western Europe
    FR:"155", DE:"155", NL:"155", BE:"155", LU:"155", CH:"155", AT:"155",
    // Northern Europe
    GB:"154", IE:"154", SE:"154", NO:"154", DK:"154", FI:"154", IS:"154",
    // Eastern Europe
    PL:"151", CZ:"151", SK:"151", HU:"151", RO:"151", BG:"151", UA:"151", BY:"151", MD:"151", RU:"151",
    // Northern Africa
    MA:"015", DZ:"015", TN:"015", LY:"015", EG:"015", SD:"015", SS:"015",
    // Sub-Saharan Africa (exemples)
    NG:"202", GH:"202", SN:"202", CI:"202", CM:"202", KE:"202", UG:"202", TZ:"202", ZA:"202",
    // Western Asia
    TR:"145", SA:"145", AE:"145", IL:"145", IQ:"145", IR:"145",
    // Southern Asia
    IN:"034", PK:"034",
    // Eastern Asia
    CN:"030", JP:"030", KR:"030",
    // South-eastern Asia
    ID:"035", TH:"035", VN:"035",
    // Northern America
    US:"021", CA:"021",
    // Latin America & Caribbean (exemples)
    MX:"419", BR:"419", AR:"419", CL:"419", CO:"419", PE:"419",
    // Australia & New Zealand
    AU:"053", NZ:"053"
  };

  function aggregateByGeoLevel(enrichedBooks, level) {
    if (level === "countries") return aggregateByCountry(enrichedBooks);

    const map = new Map(); // code -> {count, name}
    const dict = (level === "continents") ? CONTINENT_BY_ISO2 : SUBCONTINENT_BY_ISO2;

    for (const b of enrichedBooks) {
      const iso2 = b.writerCountryCode;
      if (!iso2) continue;

      const m49 = dict[iso2];
      if (!m49) continue; // si no el tenim mapat, simplement no el comptem

      const prev = map.get(m49) || { count: 0, name: m49 };
      prev.count += 1;
      map.set(m49, prev);
    }
    return map;
  }

  function aggregateByCountry(enrichedBooks) {
    const map = new Map(); // code -> {count, name}

    for (const b of enrichedBooks) {
      const code = b.writerCountryCode;
      if (!code) continue;

      const prev = map.get(code) || { count: 0, name: b.writerCountryName || code };
      prev.count += 1;
      if (!prev.name && b.writerCountryName) prev.name = b.writerCountryName;

      map.set(code, prev);
    }
    return map;
  }
  function getReadYears(enrichedBooks) {
    // Agafa anys únics de la columna "read" (números o strings numèrics)
    const years = new Set();
    for (const b of enrichedBooks) {
      const v = b.read;
      const n = (typeof v === "number") ? v : Number(v);
      if (Number.isFinite(n)) years.add(n);
    }
    return Array.from(years).sort((a, b) => a - b);
  }

  function fillYearSelect(selectEl, years) {
    // deixa l'opció ALL i afegeix la resta
    selectEl.innerHTML = `<option value="ALL">Tots</option>` + years
      .map((y) => `<option value="${y}">${y}</option>`)
      .join("");
  }

  function applyFilters(allBooks, countryCode, readYear) {
    return allBooks.filter((b) => {
      const okCountry = !countryCode || b.writerCountryCode === countryCode;
      const okYear = (readYear === "ALL") || String(b.read) === String(readYear);
      return okCountry && okYear;
    });
  }

  // ----------------------- GeoChart -----------------------
  function drawGeoChart(countryAggMap, onSelectCountry) {
  const data = new google.visualization.DataTable();
  data.addColumn("string", "Country");
  data.addColumn("number", "Books (scaled)");
  data.addColumn({ type: "string", role: "tooltip" });

  const rows = [];
  let maxCount = 0;

  for (const [code, { count, name }] of countryAggMap.entries()) {
    maxCount = Math.max(maxCount, count);

    const tooltip = `${name} — ${count} llibre${count === 1 ? "" : "s"}`;
    const painted = Math.pow(count, 0.4);
    rows.push([code, painted, tooltip]);
  }

  data.addRows(rows);

  // ticks pensats per a rang 1..~65
  const ticksReal = [1, 2, 5, 10, 20, 35, 50, 65].filter(t => t <= maxCount);
  const ticksScaled = ticksReal.map(t => Math.sqrt(t));

  const options = {
    legend: "none",
    backgroundColor: "#E8FAFF",
    datalessRegionColor: "#F1EED8",
    tooltip: { textStyle: { fontSize: 12 } },
    colorAxis: {
      colors: ["#FFE5B4", "#FFB26B", "#E36414"]
    },
    resolution: viewLevel
  };

  const chart = new google.visualization.GeoChart(document.getElementById("geo"));
  chart.draw(data, options);

  google.visualization.events.addListener(chart, "select", () => {
    const sel = chart.getSelection();
    if (!sel || !sel.length) return;
    const row = sel[0].row;
    const code = data.getValue(row, 0);
    onSelectCountry(code);
  });

  window.addEventListener("resize", () => chart.draw(data, options));
}

  // ----------------------- App -----------------------
  window.addEventListener("DOMContentLoaded", async () => {
    const app = document.getElementById("app");
    const geo = document.getElementById("geo");
    const filterPill = document.getElementById("filterPill");
    const resetLink = document.getElementById("resetLink");
    const yearSelect = document.getElementById("yearSelect");
    const yearPill = document.getElementById("yearPill");


    try {
      const enrichedBooks = await buildEnrichedBooks();

      if (!enrichedBooks.length) {
        app.textContent = "No hi ha llibres per mostrar.";
        geo.textContent = "No hi ha dades per al mapa.";
        return;
      }

      let selectedCountry = null;       // ISO2 o null
      let selectedReadYear = "ALL";     // "ALL" o any

      function updateUI() {
        const filtered = applyFilters(enrichedBooks, selectedCountry, selectedReadYear);

        // Taula
        renderTable(app, filtered);

        // Pills (any)
        if (selectedReadYear === "ALL") {
          yearPill.style.display = "none";
        } else {
          yearPill.textContent = `Any: ${selectedReadYear}`;
          yearPill.style.display = "";
        }

        // Pills (país)
        if (!selectedCountry) {
          filterPill.style.display = "none";
        } else {
          const countryName =
            filtered.find(b => b.writerCountryName)?.writerCountryName
            || enrichedBooks.find(b => b.writerCountryCode === selectedCountry)?.writerCountryName
            || selectedCountry;

          // Comptem quants llibres del conjunt filtrat són d’aquest país (ja ho són tots si país està actiu)
          const count = filtered.length;
          filterPill.textContent = `País: ${countryName} (${count})`;
          filterPill.style.display = "";
        }

        // Mostra/Amaga "Mostra tots"
        const hasAnyFilter = !!selectedCountry || selectedReadYear !== "ALL";
        resetLink.style.display = hasAnyFilter ? "" : "none";

        // Mapa: redibuixa segons el filtre d'any (i país també, però el mapa té sentit sobretot per any)
        // Si hi ha país seleccionat, el mapa quedaria amb un sol país; ho deixem igual (coherent amb el filtre combinat).
        const agg = aggregateByCountry(filtered);
        if (agg.size === 0) {
          geo.textContent = "No hi ha dades per al mapa amb aquest filtre.";
          return;
        }
        drawGeoChart(agg, (code) => { selectedCountry = code; updateUI(); });
      }

      function resetAll() {
        selectedCountry = null;
        selectedReadYear = "ALL";
        yearSelect.value = "ALL";
        updateUI();
      }

      // Omplim selector d'anys (des de la columna read)
      const years = getReadYears(enrichedBooks);
      fillYearSelect(yearSelect, years);

      yearSelect.addEventListener("change", () => {
        selectedReadYear = yearSelect.value; // "ALL" o any (string)
        updateUI();
      });

      resetLink.addEventListener("click", resetAll);

      // Carrega Google Charts i dibuixa per primer cop
      google.charts.load("current", { packages: ["geochart"] });
      google.charts.setOnLoadCallback(() => {
        updateUI(); // primer render (taula + mapa)
      });

    } catch (err) {
      console.error(err);
      app.textContent = "Error carregant dades. Mira la consola (F12).";
      geo.textContent = "No s'ha pogut carregar el mapa.";
    }
  });
</script>
</body>
</html>
