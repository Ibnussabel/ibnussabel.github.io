<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Llibres per país</title>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    #geo { width: 100%; height: 520px; border: 1px solid #eee; border-radius: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { position: sticky; top: 0; background: #f6f6f6; text-align: left; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .row { grid-template-columns: 1.2fr 1fr; } }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 12px; }
    .muted { display: none; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 6px 0 0 0; }
    .link { color: #0b57d0; cursor: pointer; text-decoration: underline; }
    .pill { font-size: 12px; background: #f3f3f3; padding: 4px 8px; border-radius: 999px; border: 1px solid #e6e6e6; }
  </style>

  <!-- Google Charts (GeoChart, estil Google Sheets) -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
  <h1>Mapa de llibres</h1>
  <p class="muted">Clica un país per filtrar la taula.</p>

  <div class="row">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Mapa del món</h2>
      <div id="geo">Carregant mapa…</div>
      <div class="toolbar">
        <span id="filterPill" class="pill" style="display:none;"></span>
        <span id="resetLink" class="link" style="display:none;">Mostra tots</span>
      </div>
      <p class="muted" style="margin-top:8px;">
        Passa el ratolí per sobre d'un país per veure el total de llibres.
      </p>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px 0;">Taula de llibres</h2>
      <div id="app">Carregant taula…</div>
    </div>
  </div>

<script>
  // ----------------------- Config -----------------------
  const URLS = {
    books: "./assets/books.json",
    writers: "./assets/writers.json",
    languages: "./assets/languages.json",
    countries: "./assets/countries.json",
  };

  // ----------------------- Load + Join -----------------------
  async function loadJSON(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Error carregant ${url}: ${res.status} ${res.statusText}`);
    return res.json();
  }

  function indexBy(arr, keyFn) {
    const map = new Map();
    for (const item of arr) map.set(keyFn(item), item);
    return map;
  }

  async function buildEnrichedBooks() {
    const [books, writers, languages, countries] = await Promise.all([
      loadJSON(URLS.books),
      loadJSON(URLS.writers),
      loadJSON(URLS.languages),
      loadJSON(URLS.countries),
    ]);

    const writersByName = indexBy(writers, (w) => w.name);
    const languagesByCode = indexBy(languages, (l) => l.code);
    const countriesByCode = indexBy(countries, (c) => c.code);

    return books.map((book) => {
      const writer = writersByName.get(book.writer) || null;
      const language = languagesByCode.get(book.language) || null;
      const country = writer ? (countriesByCode.get(writer.country) || null) : null;

      return {
        ...book,
        originalLanguageName: language?.name ?? null,
        writerGender: writer?.gender ?? null,
        writerCountryCode: writer?.country ?? null, // ISO (ex: "ES")
        writerCountryName: country?.name ?? null,   // ex: "Spain"
      };
    });
  }

  // ----------------------- Table -----------------------
  function toCellValue(v) {
    if (v === null || v === undefined) return "";
    if (typeof v === "object") return JSON.stringify(v);
    return String(v);
  }

  function renderTable(container, rows, columns) {
    const table = document.createElement("table");

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    for (const col of columns) {
      const th = document.createElement("th");
      th.textContent = col;
      trh.appendChild(th);
    }
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    for (const row of rows) {
      const tr = document.createElement("tr");
      for (const col of columns) {
        const td = document.createElement("td");
        td.textContent = toCellValue(row[col]);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);

    container.innerHTML = "";
    container.appendChild(table);
  }

  // ----------------------- Aggregation for Map -----------------------
  function aggregateByCountry(enrichedBooks) {
    // Map code -> {count, name}
    const map = new Map();

    for (const b of enrichedBooks) {
      const code = b.writerCountryCode;
      if (!code) continue;

      const prev = map.get(code) || { count: 0, name: b.writerCountryName || code };
      prev.count += 1;
      // si en algun llibre el nom ve null, no el sobreescrius amb null
      if (!prev.name && b.writerCountryName) prev.name = b.writerCountryName;

      map.set(code, prev);
    }

    return map;
  }

  // ----------------------- GeoChart -----------------------
  function drawGeoChart(countryAggMap, onSelectCountry) {
    // DataTable amb tooltip custom
    const data = new google.visualization.DataTable();
    data.addColumn("string", "Country");
    data.addColumn("number", "Books");
    data.addColumn({ type: "string", role: "tooltip" });

    const rows = [];
    for (const [code, { count, name }] of countryAggMap.entries()) {
      const tooltip = `${name} — ${count} llibre${count === 1 ? "" : "s"}`;
      rows.push([code, count, tooltip]);
    }
    data.addRows(rows);

    const options = {
      legend: { textStyle: { fontSize: 12 } },
      tooltip: { textStyle: { fontSize: 12 } },
    };

    const chart = new google.visualization.GeoChart(document.getElementById("geo"));
    chart.draw(data, options);

    // Clicar un país → filtre
    google.visualization.events.addListener(chart, "select", () => {
      const sel = chart.getSelection();
      if (!sel || !sel.length) return;

      const row = sel[0].row;
      const code = data.getValue(row, 0);
      onSelectCountry(code);
    });

    // Responsive
    window.addEventListener("resize", () => chart.draw(data, options));
  }

  // ----------------------- App -----------------------
  window.addEventListener("DOMContentLoaded", async () => {
    const app = document.getElementById("app");
    const geo = document.getElementById("geo");
    const filterPill = document.getElementById("filterPill");
    const resetLink = document.getElementById("resetLink");

    try {
      const enrichedBooks = await buildEnrichedBooks();
      if (!enrichedBooks.length) {
        app.textContent = "No hi ha llibres per mostrar.";
        geo.textContent = "No hi ha dades per al mapa.";
        return;
      }

      const columns = Object.keys(enrichedBooks[0]);

      // Render inicial taula (tots)
      function showAll() {
        renderTable(app, enrichedBooks, columns);
        filterPill.style.display = "none";
        resetLink.style.display = "none";
      }

      // Render taula filtrada per país
      function showCountry(code) {
        const filtered = enrichedBooks.filter(b => b.writerCountryCode === code);

        // Troba un nom “bonic” del país (si n’hi ha)
        const countryName = filtered.find(b => b.writerCountryName)?.writerCountryName || code;

        renderTable(app, filtered, columns);

        filterPill.textContent = `Filtrat: ${countryName} (${filtered.length})`;
        filterPill.style.display = "";
        resetLink.style.display = "";
      }

      resetLink.addEventListener("click", showAll);
      showAll();

      // Dibuixa mapa quan Google Charts estigui llest
      const countryAgg = aggregateByCountry(enrichedBooks);

      google.charts.load("current", { packages: ["geochart"] });
      google.charts.setOnLoadCallback(() => {
        if (countryAgg.size === 0) {
          geo.textContent = "No hi ha codis de país per dibuixar el mapa.";
          return;
        }
        drawGeoChart(countryAgg, showCountry);
      });

    } catch (err) {
      console.error(err);
      app.textContent = "Error carregant dades. Mira la consola (F12).";
      geo.textContent = "No s'ha pogut carregar el mapa.";
    }
  });
</script>
</body>
</html>
