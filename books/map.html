<!doctype html>
<html lang="ca">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Llibres per país</title>

    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 16px;
      }
      #geo {
        width: 100%;
        height: 520px;
        border: 1px solid #eee;
        border-radius: 10px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 12px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        vertical-align: top;
      }
      th {
        position: sticky;
        top: 0;
        background: #f6f6f6;
        text-align: left;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      @media (min-width: 900px) {
        .row {
          grid-template-columns: 1.2fr 1fr;
        }
      }
      .card {
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 12px;
      }
      .muted {
        color: #666;
        margin: 0 0 8px 0;
      }
      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin: 6px 0 0 0;
      }
      .link {
        color: #0b57d0;
        cursor: pointer;
        text-decoration: underline;
      }
      .pill {
        font-size: 12px;
        background: #f3f3f3;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid #e6e6e6;
      }
    </style>

    <script src="https://www.gstatic.com/charts/loader.js"></script>
  </head>

  <body>
    <h1>Mapa de lectures</h1>
    <p class="muted">Clica un país per filtrar la taula.</p>

    <div class="row">
      <div class="card">
        <div id="geo">Carregant mapa…</div>

        <div class="toolbar">
          <label class="muted">Any:</label>
          <select id="yearSelect">
            <option value="ALL">Tots</option>
          </select>

          <label class="muted">Vista:</label>
          <select id="viewSelect">
            <option value="countries">Països</option>
            <option value="subcontinents">Subcontinents</option>
            <option value="continents">Continents</option>
          </select>

          <span id="yearPill" class="pill" style="display: none"></span>
          <span id="filterPill" class="pill" style="display: none"></span>
          <span id="resetLink" class="link" style="display: none"
            >Mostra tots</span
          >
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h2>Taula de llibres</h2>
        <div id="app">Carregant taula…</div>
      </div>
    </div>

    <script>
      const URLS = {
        books: "./assets/books.json",
        writers: "./assets/writers.json",
        languages: "./assets/languages.json",
        countries: "./assets/countries.json",
      };

      async function loadJSON(url) {
        const r = await fetch(url);
        return r.json();
      }

      function indexBy(arr, keyFn) {
        const m = new Map();
        arr.forEach((i) => m.set(keyFn(i), i));
        return m;
      }

      async function buildEnrichedBooks() {
        const [books, writers, languages, countries] = await Promise.all([
          loadJSON(URLS.books),
          loadJSON(URLS.writers),
          loadJSON(URLS.languages),
          loadJSON(URLS.countries),
        ]);

        const writersByName = indexBy(writers, (w) => w.name);
        const countriesByCode = indexBy(countries, (c) => c.code);

        return books.map((book) => {
          const writer = writersByName.get(book.writer);
          const country = writer ? countriesByCode.get(writer.country) : null;
          return {
            ...book,
            writerCountryCode: writer?.country ?? null,
            writerCountryName: country?.name ?? null,
          };
        });
      }

      function renderTable(container, rows) {
        if (!rows.length) {
          container.innerHTML = "No hi ha dades";
          return;
        }
        let html =
          "<table><thead><tr><th>Títol</th><th>Autor</th><th>Any</th><th>País</th></tr></thead><tbody>";
        rows.forEach((r) => {
          html += `<tr><td>${r.name}</td><td>${r.writer}</td><td>${r.read ?? ""}</td><td>${r.writerCountryName ?? ""}</td></tr>`;
        });
        html += "</tbody></table>";
        container.innerHTML = html;
      }

      function aggregateByCountry(books) {
        const m = new Map();
        books.forEach((b) => {
          if (!b.writerCountryCode) return;
          const prev = m.get(b.writerCountryCode) || {
            count: 0,
            name: b.writerCountryName,
          };
          prev.count++;
          m.set(b.writerCountryCode, prev);
        });
        return m;
      }

      // UN M49 codes que fa servir GeoChart per continents/subcontinents
      const CONTINENT_BY_ISO2 = {
        AF: "142", // Asia
        AR: "019", // Amèrica
        AT: "150", // Europa
        AU: "009", // Oceania
        BA: "150", // Europa
        BD: "142", // Asia
        BE: "150", // Europa
        BG: "150", // Europa
        BI: "002", // Àfrica
        BO: "019", // Amèrica
        BY: "150", // Europa
        CA: "019", // Amèrica
        CG: "002", // Àfrica
        CH: "150", // Europa
        CN: "142", // Asia
        CO: "019", // Amèrica
        CU: "019", // Amèrica
        DE: "150", // Europa
        DZ: "002", // Àfrica
        EC: "019", // Amèrica
        ES: "150", // Europa
        FI: "150", // Europa
        FR: "150", // Europa
        GB: "150", // Europa
        GE: "142", // Asia
        GP: "019", // Amèrica
        GR: "150", // Europa
        HT: "019", // Amèrica
        HU: "150", // Europa
        IE: "150", // Europa
        IL: "142", // Asia
        IN: "142", // Asia
        IT: "150", // Europa
        JP: "142", // Asia
        KR: "142", // Asia
        MX: "019", // Amèrica
        MY: "142", // Asia
        NG: "002", // Àfrica
        NO: "150", // Europa
        NZ: "009", // Oceania
        PL: "150", // Europa
        PS: "142", // Asia
        RO: "150", // Europa
        RU: "150", // Europa
        SE: "150", // Europa
        SL: "002", // Àfrica
        TR: "142", // Asia
        TW: "142", // Asia
        UA: "150", // Europa
        US: "019", // Amèrica
        ZA: "002", // Àfrica
      };

      const SUBCONTINENT_BY_ISO2 = {
        // Asia
        AF: "034", // Àsia meridional
        BD: "034", // Àsia meridional
        IN: "034", // Àsia meridional
        CN: "030", // Àsia oriental
        JP: "030", // Àsia oriental
        KR: "030", // Àsia oriental
        TW: "030", // Àsia oriental
        MY: "035", // Àsia sud-oriental
        GE: "145", // Àsia occidental
        IL: "145", // Àsia occidental
        PS: "145", // Àsia occidental
        TR: "145", // Àsia occidental

        // Europe
        AT: "155", // Europa occidental
        BE: "155", // Europa occidental
        CH: "155", // Europa occidental
        DE: "155", // Europa occidental
        FR: "155", // Europa occidental
        ES: "039", // Europa meridional
        IT: "039", // Europa meridional
        GR: "039", // Europa meridional
        BA: "039", // Europa meridional
        BG: "151", // Europa oriental
        BY: "151", // Europa oriental
        HU: "151", // Europa oriental
        PL: "151", // Europa oriental
        RO: "151", // Europa oriental
        RU: "151", // Europa oriental
        UA: "151", // Europa oriental
        FI: "154", // Europa del nord
        GB: "154", // Europa del nord
        IE: "154", // Europa del nord
        NO: "154", // Europa del nord
        SE: "154", // Europa del nord

        // Africa
        DZ: "015", // Àfrica del nord
        BI: "014", // Àfrica oriental
        CG: "017", // Àfrica central
        NG: "011", // Àfrica occidental
        SL: "011", // Àfrica occidental
        ZA: "018", // Àfrica austral

        // Americas
        US: "021", // Amèrica del nord
        CA: "021", // Amèrica del nord
        MX: "013", // Amèrica central
        AR: "005", // Amèrica del sud
        BO: "005", // Amèrica del sud
        CO: "005", // Amèrica del sud
        EC: "005", // Amèrica del sud
        CU: "029", // Carib
        HT: "029", // Carib
        GP: "029", // Carib

        // Oceania
        AU: "053", // Austràlia i Nova Zelanda
        NZ: "053", // Austràlia i Nova Zelanda
      };

      // Noms per continents (M49)
      const M49_CONTINENT_NAME = {
        "002": "Àfrica",
        "009": "Oceania",
        "019": "Amèrica",
        142: "Àsia",
        150: "Europa",
      };

      // Noms per subcontinents (M49)
      const M49_SUBCONTINENT_NAME = {
        "014": "Àfrica oriental",
        "015": "Àfrica del nord",
        "017": "Àfrica central",
        "018": "Àfrica austral",
        "011": "Àfrica occidental",
        "029": "Carib",
        "021": "Amèrica del nord",
        "013": "Amèrica central",
        419: "Amèrica Llatina i el Carib",
        "005": "Amèrica del sud",
        "030": "Àsia oriental",
        "034": "Àsia meridional",
        "035": "Àsia sud-oriental",
        143: "Àsia central",
        145: "Àsia occidental",
        151: "Europa oriental",
        154: "Europa del nord",
        155: "Europa occidental",
        "039": "Europa meridional",
        "053": "Austràlia i Nova Zelanda",
        "054": "Melanèsia",
        "057": "Micronèsia",
        "061": "Polinèsia",
      };

      function aggregateByGeoLevel(books, level) {
        if (level === "countries") return aggregateByCountry(books);

        const dict =
          level === "continents" ? CONTINENT_BY_ISO2 : SUBCONTINENT_BY_ISO2;

        const nameMap =
          level === "continents" ? M49_CONTINENT_NAME : M49_SUBCONTINENT_NAME;

        const m = new Map();

        books.forEach((b) => {
          const iso = b.writerCountryCode;
          if (!iso || !dict[iso]) return;

          const code = dict[iso];
          const humanName = nameMap[code] || code;

          const prev = m.get(code) || { count: 0, name: humanName };
          prev.count++;
          m.set(code, prev);
        });

        return m;
      }

      function drawGeoChart(agg, onSelect, viewLevel) {
        const data = new google.visualization.DataTable();
        data.addColumn("string", "Region");
        data.addColumn("number", "Books");
        data.addColumn({ type: "string", role: "tooltip" });

        const rows = [];
        agg.forEach((v, k) => {
          const tooltip = `${v.name} — ${v.count} llibre${v.count === 1 ? "" : "s"}`;
          rows.push([k, Math.pow(v.count, 0.4), tooltip]);
        });
        data.addRows(rows);

        const options = {
          legend: "none",
          backgroundColor: "#E8FAFF",
          datalessRegionColor: "#F1EED8",
          colorAxis: { colors: ["#FFE5B4", "#FFB26B", "#E36414"] },
          resolution: viewLevel,
        };

        const chart = new google.visualization.GeoChart(
          document.getElementById("geo"),
        );
        chart.draw(data, options);

        google.visualization.events.addListener(chart, "select", () => {
          if (viewLevel !== "countries") return;
          const sel = chart.getSelection();
          if (!sel.length) return;
          const code = data.getValue(sel[0].row, 0);
          onSelect(code);
        });
      }

      window.addEventListener("DOMContentLoaded", async () => {
        const app = document.getElementById("app");
        const geo = document.getElementById("geo");
        const yearSelect = document.getElementById("yearSelect");
        const viewSelect = document.getElementById("viewSelect");
        const resetLink = document.getElementById("resetLink");

        const books = await buildEnrichedBooks();

        let selectedCountry = null;
        let selectedView = viewSelect.value;

        function update() {
          const filtered = selectedCountry
            ? books.filter((b) => b.writerCountryCode === selectedCountry)
            : books;

          renderTable(app, filtered);

          const agg = aggregateByGeoLevel(filtered, selectedView);

          drawGeoChart(
            agg,
            (code) => {
              selectedCountry = code;
              update();
            },
            selectedView,
          );

          resetLink.style.display = selectedCountry ? "" : "none";
        }

        viewSelect.addEventListener("change", () => {
          selectedView = viewSelect.value;
          selectedCountry = null;
          update();
        });

        resetLink.addEventListener("click", () => {
          selectedCountry = null;
          update();
        });

        google.charts.load("current", { packages: ["geochart"] });
        google.charts.setOnLoadCallback(update);
      });
    </script>
  </body>
</html>
